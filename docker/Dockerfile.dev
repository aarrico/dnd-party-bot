FROM node:24-alpine

WORKDIR /usr/src/app

# Install dependencies first for better caching
COPY package.json package-lock.json ./
COPY prisma ./prisma
RUN npm ci

# Install Vecna font to image
RUN apk add fontconfig openssl
COPY resources/fonts/*.ttf /usr/share/fonts/truetype/
RUN fc-cache -f -v

# Copy resources directory for images
COPY resources ./resources

# Copy source code (this will be mounted as volume in dev)
COPY . .

# Generate Prisma client
RUN npx prisma generate

# Expose the port and debug port
EXPOSE ${PORT:-3000}
EXPOSE 9229

# Use tsx for hot reloading in development with debug support
CMD ["npx", "tsx", "watch", "--inspect=0.0.0.0:9229", "src/index.ts"]
