generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum SessionStatus {
  SCHEDULED
  ACTIVE
  COMPLETED
  CANCELED
}

enum RoleType {
  GAME_MASTER
  TANK
  SUPPORT
  RANGE_DPS
  MELEE_DPS
  FACE
  CONTROL
}

// Discord Server/Guild
model Campaign {
  id        String   @id // discord id
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sessions      Session[]
  factionMember Faction[]

  @@map("campaign")
}

// discord channel with channel type GUILD_TEXT
model Session {
  id             String        @id // discord channel id
  campaignId     String        @map("campaign_id")
  campaign       Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  name           String
  date           DateTime
  timezone       String        @default("America/Los_Angeles")
  status         SessionStatus @default(SCHEDULED)
  partyMessageId String        @map("party_message_id")
  eventId        String?       @map("event_id") // discord scheduled event id
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  partyMembers PartyMember[]

  @@map("session")
}

model User {
  id        String @id
  channelId String @unique
  username  String @unique
  timezone  String @default("America/Los_Angeles")

  sessions PartyMember[]
  factions Faction[]

  @@map("user")
}

model Faction {
  campaignId String   @map("campaign_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@id([campaignId, userId], name: "campaign_member_id")
  @@map("campaign_member")
}

model PartyMember {
  sessionId String   @map("session_id")
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  roleId    RoleType @map("role_id")
  role      Role     @relation(fields: [roleId], references: [id])

  @@id(fields: [sessionId, userId], name: "party_member_id")
  @@map("party_member")
}

model Role {
  id          RoleType      @id
  emojiId     String        @map("emoji_id")
  displayName String        @default("") @map("display_name")
  imagePath   String        @default("") @map("image_path")
  description String?       @map("description")
  PartyMember PartyMember[]

  @@map("role")
}
